<!doctype html><html lang=en><head><meta charset=utf-8><script>(()=>{try{const a={light:`gruvbox-light`,dark:`night-solis`};const b=window.matchMedia(`(prefers-color-scheme: dark)`).matches;const c=localStorage.theme||(b?a.dark:a.light);document.documentElement.dataset.theme=c}catch(a){}})()</script><link href=/assets/css/themes.css rel=stylesheet><link href=/assets/css/readable.css rel=stylesheet><link href=/assets/css/global.css rel=stylesheet><link href=/assets/css/fonts.css rel=stylesheet><link href=/assets/css/logo.css rel=stylesheet><link href=https://scientiac.space/atom.xml rel=alternate title=RSS type=application/atom+xml><meta content=POSSE property=og:type><meta content=scientiac.space property=og:site_name><meta content=https://scientiac.space/res/thumbnail-light.png property=og:image><title>KL-OS: User Mode</title><meta content="KL-OS: User Mode" name=og:title><meta content="
Day 12 was about user mode.
The application that we had made had to be run on the user mode. And since, the execution
image is a raw binary, it needs to be prepared with a fixed binary.
#define USER_BASE 0x1000000

After defining the symbols to use in the embedded raw binary, the create process function is updated to start the application from the user_entry.
The create_process is modified to take the pointer to the execution image and image size as arguments. It copies the execution image page by page for the specified size and maps it to the process page table.
Finally, the create_process function is modified to create a user process.
After checking if the execution image is mapped as expected, to run applications we must transition the CPU to the user mode. Or, in RISC-V, the U-Mode.
This switch from S-Mode to U-mode is done with the sret instruction. It does two writes to CSRs while switching:

PC is set for when transitioning in U-Mode in the sepc register where sret jumps to.
Then, setting SPIE bit in the sstatus register enables hardware interrupts and the handler set in the stvec register will be called while entering the U-Mode.

" name=description><meta content="
Day 12 was about user mode.
The application that we had made had to be run on the user mode. And since, the execution
image is a raw binary, it needs to be prepared with a fixed binary.
#define USER_BASE 0x1000000

After defining the symbols to use in the embedded raw binary, the create process function is updated to start the application from the user_entry.
The create_process is modified to take the pointer to the execution image and image size as arguments. It copies the execution image page by page for the specified size and maps it to the process page table.
Finally, the create_process function is modified to create a user process.
After checking if the execution image is mapped as expected, to run applications we must transition the CPU to the user mode. Or, in RISC-V, the U-Mode.
This switch from S-Mode to U-mode is done with the sret instruction. It does two writes to CSRs while switching:

PC is set for when transitioning in U-Mode in the sepc register where sret jumps to.
Then, setting SPIE bit in the sstatus register enables hardware interrupts and the handler set in the stvec register will be called while entering the U-Mode.

" name=og:description><link rel="shortcut icon" href=/res/thumbnail.svg type=image/x-icon><meta content="width=device-width,initial-scale=1" name=viewport><meta content="rgb(253, 246, 227)" name=theme-color><script defer src=/assets/js/copy-button.js></script><link href=https://github.com/scientiac rel=me><link href=mailto:spandan@scientiac.space rel=me><link href=https://webmention.io/scientiac.space/webmention rel=webmention><meta content=@iac@polymaths.social name=fediverse:creator><body onload=updateThemeSelector();><div class=logo-container><a href=/> <div class=inner-logo-container></div> </a></div><nav data-style=classy><span><a href=/>Main</a></span><span><a href=/blog>Blog</a></span><span><a href=/syndications>Ping</a></span><span><a href=/more>More</a></span></nav><section class=section-body><div class=container><div id=html-content-holder><div class="h-entry syndicate-inside"><h2 class="p-name title syndicate-inside-title">KL-OS: User Mode</h2><div class=syndicate-pagedate><time class="dt-published dateandtag hidden" datetime=2026-01-02T00:00:00Z> 2026-01-02 </time><code class="dt-published dateandtag">2026-01-02</code><code class="u-category dateandtag">POSSE</code></div><a class="u-url hidden" href=https://scientiac.space/syndications/kl-os-2026-01-02/>https://scientiac.space/syndications/kl-os-2026-01-02/</a><div class="hidden p-author h-card"><a class=u-url href=https://scientiac.space rel=me> <img alt="Profile photo of scientiac" class=u-photo src=/res/thumbnail.png> <span class=p-name>scientiac</span> </a></div><div class="section syndicate-inside-text e-content"><a class=u-bridgy-fed hidden href=https://fed.brid.gy/></a><p><a href=https://codeberg.org/scientiac/KL-OS/src/branch/main/progress/day-12.md>Day 12</a> was about user mode.<p>The application that we had made had to be run on the user mode. And since, the execution image is a raw binary, it needs to be prepared with a fixed binary.<pre class=language-c data-lang=c style=color:#fdf4c1aa;background-color:#282828><code class=language-c data-lang=c><span style=color:#fa5c4b>#define </span><span style=color:#8ec07c>USER_BASE </span><span style=color:#d3869b>0x1000000
</span></code></pre><p>After defining the symbols to use in the embedded raw binary, the create process function is updated to start the application from the <code>user_entry</code>.<p>The <code>create_process</code> is modified to take the pointer to the execution image and image size as arguments. It copies the execution image page by page for the specified size and maps it to the process page table.<p>Finally, the <code>create_process</code> function is modified to create a user process.<p>After checking if the execution image is mapped as expected, to run applications we must transition the CPU to the user mode. Or, in RISC-V, the U-Mode.<p>This switch from <code>S-Mode</code> to <code>U-mode</code> is done with the <code>sret</code> instruction. It does two writes to CSRs while switching:<ul><li><code>PC</code> is set for when transitioning in U-Mode in the <code>sepc</code> register where <code>sret</code> jumps to.<li>Then, setting <code>SPIE</code> bit in the <code>sstatus</code> register enables hardware interrupts and the handler set in the <code>stvec</code> register will be called while entering the <code>U-Mode</code>.</ul></div></div></div><div id=webmention><hr><h2>Webmentions</h2><form action=https://webmention.io/scientiac.space/webmention class=webmention-form method=post><div id=email-comment><p>Have you written a <a href=https://indieweb.org/responses>response</a> to this? Let me know the URL, Or, you can send your response via <a href="mailto:iac@scientiac.space?subject=Reply%3A%20KL-OS%3A%20User%20Mode">mail:</a><code>iac@scientiac.space</code></div><div class=send-webmention><input name=source type=url><button>Send Webmention</button></div><div><div class="ui message"></div></div><input name=target type=hidden value=https://scientiac.space/syndications/kl-os-2026-01-02/></form><div class=interaction-box></div></div></div><script defer src=/assets/js/themeSelector.js></script></section><div class=hidden><a href=https://polymaths.social/@iac rel=me>Fediverse</a></div><div class="hidden h-card"><img class="u-photo icon" alt=scientiac src=/res/thumbnail.png><a class="p-name u-url" href=https://scientiac.space rel=me>scientiac</a><p class=p-note>A Computer Engineering student who loves FOSS and is learning about privacy, the Internet and languages writing about the things he does.</div><footer><p class=codewithlove>I can't think of things to write on a footer. So, just <span class=main-background>imagine</span> something yourself.<p><a href=/series>Series</a> | <a href=/atom.xml>RSS</a> | <a href=https://github.com/scientiac/scientiac.github.io target=_blank>Source Code</a><p>All articles are usable under <a href=https://creativecommons.org/licenses/by-sa/4.0/ target=_blank>CC BY-SA 4.0</a>.</footer><ol id=themeSelector reversed></ol>