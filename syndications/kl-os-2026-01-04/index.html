<!doctype html><html lang=en><head><meta charset=utf-8><script>(()=>{try{const a={light:`gruvbox-light`,dark:`night-solis`};const b=window.matchMedia(`(prefers-color-scheme: dark)`).matches;const c=localStorage.theme||(b?a.dark:a.light);document.documentElement.dataset.theme=c}catch(a){}})()</script><link href=/assets/css/themes.css rel=stylesheet><link href=/assets/css/readable.css rel=stylesheet><link href=/assets/css/global.css rel=stylesheet><link href=/assets/css/fonts.css rel=stylesheet><link href=/assets/css/logo.css rel=stylesheet><link href=https://scientiac.space/atom.xml rel=alternate title=RSS type=application/atom+xml><meta content=POSSE property=og:type><meta content=scientiac.space property=og:site_name><meta content=https://scientiac.space/res/thumbnail-light.png property=og:image><title>KL-OS: Disk I/O</title><meta content="KL-OS: Disk I/O" name=og:title><meta content='
Day 14 was about Disk I/O.
A device driver for the virtio-blk, a virtual disk device was implemented.
Virtio is one of the APIs for device drivers to control devices. It is widely used in virtualization environments such as QEMU.
The virtio devices have a structure called virtqueue and it is a queue shared between the driver and the device.
It consists of Discriptor Table, Available Ring and Used Ring.
First we enable virtio drivers in our buildscript which is run.sh. We use the following flags for qemu:
    -drive id=drive0,file=lorem.txt,format=raw,if=none
    -device virtio-blk-device,drive=drive0,bus=virtio-mmio-bus.0

Here, lorem.txt is a file made for testing purposes beforehand.
Then, the definition of c structs and macros is done in kernel.h. To access the MMIO registers we add that functionality in kernel.c.
The create_process function is modified to map the virtio-blk MMIO region to the page table so the kernel can access the MMIO registers. MMIO region to the page table so the kernel can access the MMIO registers.
Then the Virtio Device Initialization and Virtqueue Initialization is done with the process described in the spec.
I/O requests to the disk is implemented by "adding processing requests to the virtqueue".
A request is sent in the following steps:

Construct a request in blk_req. Specify the sector number you want to access and the type of read/write.
Construct a descriptor chain pointing to each area of blk_req (see below).
Add the index of the head descriptor of the descriptor chain to the Available Ring.
Notify the device that there is a new pending request.
Wait until the device finishes processing (aka busy-waiting or polling).
Check the response from the device.

To test, we initialize the virtio device in the kernel main and try reading and writing to the disk with the implemented functions.

Device drivers are just "glue" between the OS and devices. Drivers don&#39t control the hardware directly; drivers communicate with other software running on the device (e.g., firmware). Devices and their software, not the OS driver, will do the rest of the heavy lifting, like moving disk read/write heads.

' name=description><meta content='
Day 14 was about Disk I/O.
A device driver for the virtio-blk, a virtual disk device was implemented.
Virtio is one of the APIs for device drivers to control devices. It is widely used in virtualization environments such as QEMU.
The virtio devices have a structure called virtqueue and it is a queue shared between the driver and the device.
It consists of Discriptor Table, Available Ring and Used Ring.
First we enable virtio drivers in our buildscript which is run.sh. We use the following flags for qemu:
    -drive id=drive0,file=lorem.txt,format=raw,if=none
    -device virtio-blk-device,drive=drive0,bus=virtio-mmio-bus.0

Here, lorem.txt is a file made for testing purposes beforehand.
Then, the definition of c structs and macros is done in kernel.h. To access the MMIO registers we add that functionality in kernel.c.
The create_process function is modified to map the virtio-blk MMIO region to the page table so the kernel can access the MMIO registers. MMIO region to the page table so the kernel can access the MMIO registers.
Then the Virtio Device Initialization and Virtqueue Initialization is done with the process described in the spec.
I/O requests to the disk is implemented by "adding processing requests to the virtqueue".
A request is sent in the following steps:

Construct a request in blk_req. Specify the sector number you want to access and the type of read/write.
Construct a descriptor chain pointing to each area of blk_req (see below).
Add the index of the head descriptor of the descriptor chain to the Available Ring.
Notify the device that there is a new pending request.
Wait until the device finishes processing (aka busy-waiting or polling).
Check the response from the device.

To test, we initialize the virtio device in the kernel main and try reading and writing to the disk with the implemented functions.

Device drivers are just "glue" between the OS and devices. Drivers don&#39t control the hardware directly; drivers communicate with other software running on the device (e.g., firmware). Devices and their software, not the OS driver, will do the rest of the heavy lifting, like moving disk read/write heads.

' name=og:description><link rel="shortcut icon" href=/res/thumbnail.svg type=image/x-icon><meta content="width=device-width,initial-scale=1" name=viewport><meta content="rgb(253, 246, 227)" name=theme-color><script defer src=/assets/js/copy-button.js></script><link href=https://github.com/scientiac rel=me><link href=mailto:spandan@scientiac.space rel=me><link href=https://webmention.io/scientiac.space/webmention rel=webmention><meta content=@iac@polymaths.social name=fediverse:creator><body onload=updateThemeSelector();><div class=logo-container><a href=/> <div class=inner-logo-container></div> </a></div><nav data-style=classy><span><a href=/>Main</a></span><span><a href=/blog>Blog</a></span><span><a href=/syndications>Ping</a></span><span><a href=/more>More</a></span></nav><section class=section-body><div class=container><div id=html-content-holder><div class="h-entry syndicate-inside"><h2 class="p-name title syndicate-inside-title">KL-OS: Disk I/O</h2><div class=syndicate-pagedate><time class="dt-published dateandtag hidden" datetime=2026-01-04T00:00:00Z> 2026-01-04 </time><code class="dt-published dateandtag">2026-01-04</code><code class="u-category dateandtag">POSSE</code></div><a class="u-url hidden" href=https://scientiac.space/syndications/kl-os-2026-01-04/>https://scientiac.space/syndications/kl-os-2026-01-04/</a><div class="hidden p-author h-card"><a class=u-url href=https://scientiac.space rel=me> <img alt="Profile photo of scientiac" class=u-photo src=/res/thumbnail.png> <span class=p-name>scientiac</span> </a></div><div class="section syndicate-inside-text e-content"><a class=u-bridgy-fed hidden href=https://fed.brid.gy/></a><p><a href=https://codeberg.org/scientiac/KL-OS/src/branch/main/progress/day-14.md>Day 14</a> was about Disk <code>I/O</code>.<p>A device driver for the <code>virtio-blk</code>, a virtual disk device was implemented.<p><code>Virtio</code> is one of the APIs for device drivers to control devices. It is widely used in virtualization environments such as QEMU. The <code>virtio</code> devices have a structure called <code>virtqueue</code> and it is a queue shared between the driver and the device. It consists of <code>Discriptor Table</code>, <code>Available Ring</code> and <code>Used Ring</code>.<p>First we enable <code>virtio</code> drivers in our <code>buildscript</code> which is <code>run.sh</code>. We use the following flags for <code>qemu</code>:<pre class=language-sh data-lang=sh style=color:#fdf4c1aa;background-color:#282828><code class=language-sh data-lang=sh><span>    </span><span style=color:#fdf4c1>-drive id=drive0,file=lorem.txt,format=raw,if=none
</span><span>    </span><span style=color:#fdf4c1>-device virtio-blk-device,drive=drive0,bus=virtio-mmio-bus.0
</span></code></pre><p>Here, <code>lorem.txt</code> is a file made for testing purposes beforehand.<p>Then, the definition of <code>c</code> structs and macros is done in <code>kernel.h</code>. To access the <code>MMIO</code> registers we add that functionality in <code>kernel.c</code>.<p>The <code>create_process</code> function is modified to map the <code>virtio-blk</code> <code>MMIO</code> region to the page table so the kernel can access the <code>MMIO</code> registers. <code>MMIO</code> region to the page table so the kernel can access the <code>MMIO</code> registers.<p>Then the <code>Virtio Device Initialization</code> and <code>Virtqueue Initialization</code> is done with the process described in the <a href=https://ozlabs.org/~rusty/virtio-spec/virtio-0.9.5.pdf>spec</a>.<p><code>I/O</code> requests to the disk is implemented by "adding processing requests to the <code>virtqueue</code>".<p>A request is sent in the following steps:<ol><li>Construct a request in <code>blk_req</code>. Specify the sector number you want to access and the type of read/write.<li>Construct a descriptor chain pointing to each area of <code>blk_req</code> (see below).<li>Add the index of the head descriptor of the descriptor chain to the Available Ring.<li>Notify the device that there is a new pending request.<li>Wait until the device finishes processing (aka busy-waiting or polling).<li>Check the response from the device.</ol><p>To test, we initialize the <code>virtio</code> device in the kernel main and try reading and writing to the disk with the implemented functions.<blockquote><p>Device drivers are just "glue" between the OS and devices. Drivers don't control the hardware directly; drivers communicate with other software running on the device (e.g., firmware). Devices and their software, not the OS driver, will do the rest of the heavy lifting, like moving disk read/write heads.</blockquote></div></div></div><div id=webmention><hr><h2>Webmentions</h2><form action=https://webmention.io/scientiac.space/webmention class=webmention-form method=post><div id=email-comment><p>Have you written a <a href=https://indieweb.org/responses>response</a> to this? Let me know the URL, Or, you can send your response via <a href="mailto:iac@scientiac.space?subject=Reply%3A%20KL-OS%3A%20Disk%20I/O">mail:</a><code>iac@scientiac.space</code></div><div class=send-webmention><input name=source type=url><button>Send Webmention</button></div><div><div class="ui message"></div></div><input name=target type=hidden value=https://scientiac.space/syndications/kl-os-2026-01-04/></form><div class=interaction-box></div></div></div><script defer src=/assets/js/themeSelector.js></script></section><div class=hidden><a href=https://polymaths.social/@iac rel=me>Fediverse</a></div><div class="hidden h-card"><img class="u-photo icon" alt=scientiac src=/res/thumbnail.png><a class="p-name u-url" href=https://scientiac.space rel=me>scientiac</a><p class=p-note>A Computer Engineering student who loves FOSS and is learning about privacy, the Internet and languages writing about the things he does.</div><footer><p class=codewithlove>I can't think of things to write on a footer. So, just <span class=main-background>imagine</span> something yourself.<p><a href=/series>Series</a> | <a href=/atom.xml>RSS</a> | <a href=https://github.com/scientiac/scientiac.github.io target=_blank>Source Code</a><p>All articles are usable under <a href=https://creativecommons.org/licenses/by-sa/4.0/ target=_blank>CC BY-SA 4.0</a>.</footer><ol id=themeSelector reversed></ol>