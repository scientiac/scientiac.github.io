+++
title = "KL-OS: Exceptions"
date = 2025-12-27

[taxonomies]
syndicate=["POSSE"]
series=["OS in 1000 LOC"]
+++

{{ bridgy() }}

[Day 6](https://codeberg.org/scientiac/KL-OS/src/branch/main/progress/day-6.md) was about Exceptions and handling those Exceptions in the kernel.

In RISC-V the CPU first checks `medeleg` register to determine which operation mode should handle the exception.
In our case `U-mode/S-mode` is already handled by `OpenSBI`.
Then, the CPU saves states into various `CSRs`.
`stvec` register is set to `pc` then the exception is handled using the handler. Then `sret` is called to resume execution from the point where exception occurred.

The `handle_trap` function reads why the exception occurred and triggers the kernel panic. Which was implemented yesterday.
